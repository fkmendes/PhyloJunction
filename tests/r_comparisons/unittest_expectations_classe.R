library(diversitree)
library(phytools)
library(stringr)

source("unittest_R_utils.R")

## ClaSSE (GeoSSE effectively)
## params
mu1 <- 0.6
mu2 <- 0.4
mu3 <- 0.0 # cannot go extinct in widespread
q12 <- 0.0 # from A to B entirely cannot happen
q13 <- 0.9
q21 <- 0.0 # from B to A entirely cannot happen
q23 <- 0.4
q31 <- mu2 # going from AB to A means dying in B
q32 <- mu1 # going from AB to B means dying in A

lambda111 <- 0.9
lambda112 <- 0.0 # speciation in A + migration to B with extinction in A = cannot happen
lambda113 <- 0.0 # speciation in A + migration to B = cannot happen
lambda122 <- 0.0 # speciation in A + two migrations to B followed by extinctions in A = not allowing
lambda123 <- 0.0 # speciation in A + migration to B with extinction in A + migration to B = cannot happen
lambda133 <- 0.0 # speciation in A + two migrations to B = cannot happen

lambda211 <- 0.0 # speciation in B + two migrations to A followed by extinctions in B = cannot happen
lambda212 <- 0.0 # speciation in B + migration to A followed by extinction in B = cannot happen
lambda213 <- 0.0 # speciation in B + migration to A + migration to A followed by extinction in B = cannot happen
lambda222 <- 0.7
lambda223 <- 0.0 # speciation in B + migration to A = cannot happen
lambda233 <- 0.0 # speciation in B + two migrations to A = cannot happen

lambda311 <- 0.0 # speciation in AB + two extinctions in B = cannot happen
lambda312 <- 1.2 # vicariant speciation
lambda313 <- lambda111 # speciation in A when species is widespread
lambda322 <- 0.0 # speciation in AB + two extinctions in A = cannot happen
lambda323 <- lambda222 # speciation in B when species is widespread
lambda333 <- 0.0 # no speciation in widespread state

pars = c(lambda111, lambda112, lambda113, lambda122, lambda123, lambda133,
         lambda211, lambda212, lambda213, lambda222, lambda223, lambda233,
         lambda311, lambda312, lambda313, lambda322, lambda323, lambda333,
         mu1, mu2, mu3,
         q12, q13, q21, q23, q31, q32)

## simulation specs
n.batches <- 100
n.sim <- 100
size.tr <- 50 # for simulations with max.taxa
max.age <- 3.0 # for simulations with max.age

## storing things
trs.list.max.taxa <- rep(list(vector(mode="list", length=n.sim)), n.batches) # store trees with different ages, same number of extant taxa
spec.df.max.taxa <- as.data.frame(matrix(rep(0, n.batches * n.sim * 6), nrow=n.batches * n.sim))

trs.list.max.t <- rep(list(vector(mode="list", length=n.sim)), n.batches) # store trees with different numbers of extant taxa, same origin age (but different root age)

spec.df.max.t <- as.data.frame(matrix(rep(0, n.batches * n.sim * 6), nrow=n.batches * n.sim))

names(spec.df.max.taxa) <- names(spec.df.max.t) <-  c("ntotal", "ntips", "n1", "n2", "n3", "root.age")


######## max.taxa ########
set.seed(123)
null.count <- 0
for (b in 1:n.batches) {
    null.count = 0 # in case we want to know anything about this later

    if (b %% 5 == 0) { cat("batch ", b, "\r") }

    for (i in 1:n.sim) {
        tr.max.taxa = NULL

        ## conditioning on speciation (done by default by diversitree)
        while (is.null(tr.max.taxa)) {
            tr.max.taxa = tree.classe(pars, max.taxa=size.tr, x0=1, include.extinct=TRUE)

            if (!is.null(tr.max.taxa)) {
                ## conditioning on survival
                while (length(table(str_detect(tr.max.taxa$tip.label, "ex"))) <2) {
                    tr.max.taxa = tree.classe(pars, max.taxa=size.tr, x0=1, include.extinct=TRUE)
                }

                trs.list.max.taxa[[b]][[i]] = tr.max.taxa # b-th batch, i-th tree with max.taxa
                ith.specs.df.max.taxa = get.specs(tr.max.taxa, w.states=TRUE, w.root=TRUE, three.states=TRUE)
                spec.df.max.taxa$ntotal[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"n.total"
                spec.df.max.taxa$root.age[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"tr.h"
                spec.df.max.taxa$ntips[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"n.tips"
                spec.df.max.taxa$n1[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"n.0"
                spec.df.max.taxa$n2[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"n.1"
                spec.df.max.taxa$n3[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"n.2"
            } else {
                null.count = null.count + 1
            }
        }
    }
}

## getting stats (mean, stdev, stderr) for different tree specs
mean.df.max.taxa <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
sd.df.max.taxa <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
stderr.df.max.taxa <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
names(mean.df.max.taxa) <- names(sd.df.max.taxa) <- names(stderr.df.max.taxa) <- c("ntotal", "ntips", "n1", "n2", "n3", "root.age")
n1.ci.width.max.taxa <- n2.ci.width.max.taxa <- n3.ci.width.max.taxa <- root.age.ci.width.max.taxa <- rep(0.0, n.batches)
for (b in 1:n.batches) {
    bth.batch.df.all = spec.df.max.taxa[((b-1) * n.batches + 1):((b-1) * n.batches + n.sim),]
    bth.batch.df = bth.batch.df.all[bth.batch.df.all$ntips==size.tr,]
    mean.df.max.taxa[b,] = sapply(bth.batch.df, mean)
    sd.df.max.taxa[b,] = sapply(bth.batch.df, sd)
    stderr.df.max.taxa[b,] = sd.df.max.taxa[b,] / sqrt(n.sim)

    n1.ci.width.max.taxa[b] = 1.96 * stderr.df.max.taxa[b, "n1"] # actually half width, which we use in unit test
    n2.ci.width.max.taxa[b] = 1.96 * stderr.df.max.taxa[b, "n2"]
    n3.ci.width.max.taxa[b] = 1.96 * stderr.df.max.taxa[b, "n3"]
    root.age.ci.width.max.taxa[b] = 1.96 * stderr.df.max.taxa[b, "root.age"]
}

## getting means and 95-CI widths (for unit test)
cat("\nn1_ci_width_maxtaxa = [", paste(n1.ci.width.max.taxa, collapse=", "), "]\n")
cat("\nn1_mean = [", paste(mean.df.max.taxa$n1, collapse=", "), "]\n")
cat("\nn2_ci_width_maxtaxa = [", paste(n2.ci.width.max.taxa, collapse=", "), "]\n")
cat("\nn2_mean = [", paste(mean.df.max.taxa$n2, collapse=", "), "]\n")
cat("\nn3_ci_width_maxtaxa = [", paste(n3.ci.width.max.taxa, collapse=", "), "]\n")
cat("\nn3_mean = [", paste(mean.df.max.taxa$n3, collapse=", "), "]\n")
cat("\nroot_ages_ci_width_maxtaxa = [", paste(root.age.ci.width.max.taxa, collapse=", "), "]\n")
cat("\nroot_ages_mean_maxtaxa = [", paste(mean.df.max.taxa$root.age, collapse=", "), "]\n")

## n1_ci_width_maxtaxa = [ 1.33148919498569, 1.31801361100251, 1.40783445479972, 1.27859702088585, 1.42576435017229, 1.45010567584266, 1.50838729265612, 1.3304731619794, 1.45984020379152, 1.39555536897638, 1.45940420997091, 1.21229068487985, 1.23097432051923, 1.35532349800423, 1.43056810075896, 1.39452062274917, 1.28250000492252, 1.42137577058712, 1.33575913331043, 1.25284458491043, 1.149974650577, 1.24997942673979, 1.16104988782576, 1.38224397910708, 1.20310616104626, 1.34280555088023, 1.2758018648614, 1.40721828850934, 1.3316931827299, 1.35186190436925, 1.24986766426763, 1.37476751180523, 1.58350925772252, 1.39291134685665, 1.29779277672251, 1.23516605124227, 1.47226973593616, 1.36936150335428, 1.41180893147405, 1.37424805724013, 1.35316874652264, 1.38575428900471, 1.51776979183607, 1.25562903805707, 1.33817392537198, 1.4498848935155, 1.14519170182961, 1.24070641266346, 1.20733197396306, 1.35463618374198, 1.51585109260425, 1.27327640678715, 1.44198418349667, 1.42743309404672, 1.15158645495348, 1.34184580306081, 1.208809524727, 1.36003367456824, 1.39078553488322, 1.48894860823999, 1.32952786090751, 1.32807942989914, 1.41570783951657, 1.38393856289164, 1.27415837399446, 1.37408568741678, 1.2044600342649, 1.51346211760128, 1.46169438141031, 1.36402226054883, 1.32271583180862, 1.3198391796738, 1.27176848855633, 1.32769369413828, 1.09642563437616, 1.36987148022113, 1.3400632453038, 1.37660801929521, 1.21631711441888, 1.45814734038184, 1.10079660778782, 1.57714966834592, 1.46557972450798, 1.17665974759748, 1.3232863064692, 1.25938136552769, 1.33053149188927, 1.27550528011293, 1.23523987675727, 1.23536552706256, 1.27882765188759, 1.2947618596218, 1.48697575860088, 1.42722647697051, 1.47477543519087, 1.44228554591648, 1.3054945955422, 1.35463761600919, 1.50933369472102, 1.30562537297092 ]

## n1_mean = [ 28.18, 29.65, 29.77, 29.01, 29.44, 29.36, 29.69, 29.39, 29.14, 28.9, 28.18, 29.08, 28.3, 29.89, 30, 28.62, 28.85, 29.66, 29.17, 30.51, 27.8, 29.57, 29.02, 29.27, 29.41, 27.85, 29.29, 28.74, 29.72, 29.94, 29.11, 28.79, 29.02, 29, 29.34, 28.94, 28.98, 29.42, 28.79, 29.97, 29.75, 29.55, 29.88, 29.51, 29.75, 31.19, 28.77, 30.01, 29.66, 29.51, 29.62, 29.6, 29.43, 29.47, 29.62, 29.33, 28.94, 28.95, 29.55, 29.74, 28.63, 28.69, 28.7, 29.89, 28.89, 29.68, 29.29, 30.47, 30.4, 28.45, 28.85, 29.78, 29.33, 30.85, 29.2, 28.98, 28.11, 29.06, 28.88, 30.13, 30.45, 30.28, 29.87, 28.6, 28.56, 29.37, 27.41, 28.56, 28.17, 27.53, 31.07, 29.59, 29.17, 29.31, 29.99, 29.05, 27.67, 28.7, 29.55, 30.99 ]

## n2_ci_width_maxtaxa = [ 1.65879776545143, 1.66918326898353, 1.63472968191359, 1.65339926359258, 1.61573393349226, 1.75063633844809, 1.70857483289318, 1.80834444023959, 1.77321389390433, 1.43824420173988, 1.60323551443557, 1.41262913045216, 1.89178796983919, 1.75472666886448, 1.87436808864139, 1.51010477929329, 1.64944583580442, 1.55246077925051, 1.77783840194612, 1.72791087686369, 1.62711482897387, 1.71578636517169, 1.69486462616048, 1.81752247842935, 1.7089370405269, 1.56119949533762, 1.59109257931762, 1.82856423226398, 1.83053248575767, 1.8084259800314, 1.4991906832176, 1.8735677674944, 1.70242146783381, 1.67881821060007, 1.77682208655586, 1.3373399800433, 1.7739632437858, 1.60526732774805, 1.74917168275661, 1.46710532503548, 1.55779433764019, 1.63065960552499, 1.64628215066433, 1.67018725134203, 1.86435759304579, 1.67088410638491, 1.74586754747699, 1.41967120734686, 1.55535128072878, 1.93495290950974, 1.7298770089988, 1.59618037967031, 1.6091303509861, 1.60044968226263, 1.50444098145014, 1.59695812813934, 1.44931873428013, 1.58676875607397, 1.57578109744682, 1.68828555150909, 1.56187044354653, 1.73393238878824, 1.5461943374922, 1.50859308274065, 1.67453667899301, 1.57516534530522, 1.50408112611634, 1.61885304902682, 1.57901231422837, 1.68211448414719, 1.419764136906, 1.61440648455516, 1.60449360701422, 1.57996184789636, 1.48005073131725, 1.63716687091827, 1.66626201148231, 1.48859282803484, 1.55524774004957, 1.72240007506556, 1.72272333662299, 1.54959243178536, 1.53735392506381, 1.91992606381211, 1.72206210613141, 1.63902523384227, 1.58681399672489, 1.56614283957096, 1.6368030056155, 1.58348475244068, 1.66667066714671, 1.81837520947252, 1.40356122816645, 1.64169360986966, 1.86345822750513, 1.52760022852244, 1.56780695781391, 1.58461650078038, 1.7346349537082, 1.61298291962125 ]

## n2_mean = [ 39.36, 37.67, 37.82, 37.48, 37.94, 39.98, 37.5, 39.74, 38.51, 37.95, 39.02, 38.12, 39.03, 39.03, 38.96, 38.55, 38.13, 37.64, 38.37, 38.24, 38.65, 38.56, 38.05, 39.1, 36.41, 39.78, 38.4, 38.55, 38.37, 37.8, 36.67, 40.17, 38.03, 37.74, 38.6, 37.7, 40.04, 38.18, 41.15, 37.46, 37.11, 38.43, 38.34, 38.45, 38.19, 36.95, 39.49, 38.02, 39.09, 38.71, 37.68, 38.61, 39.18, 37.52, 37.95, 36.41, 37.22, 38.71, 38.64, 37.31, 37.88, 40.02, 38.3, 36.49, 37.76, 39.14, 37.98, 38.06, 35.87, 37.89, 38.44, 38.79, 38.58, 39.36, 38.78, 38.37, 38.7, 37.43, 37.92, 38.74, 37.83, 37.67, 38.05, 38.63, 37.76, 37.9, 39.48, 39.3, 37.76, 39.68, 37.07, 38.01, 37.85, 38.38, 38.35, 38.23, 38.34, 37.7, 39.76, 36.85 ]

## n3_ci_width_maxtaxa = [ 0.477928973210815, 0.565086125195876, 0.612551670547807, 0.538100240746005, 0.590055397501974, 0.465424188403992, 0.543096116276992, 0.500813134368055, 0.497856212254912, 0.558555713289628, 0.504422415573826, 0.466069885079242, 0.564838861798637, 0.474486208461534, 0.478882029714875, 0.505989306390776, 0.527558621760596, 0.462245138515061, 0.453717218923279, 0.460339814756996, 0.492748172205764, 0.456501060881416, 0.545352809906328, 0.577932329756502, 0.528484589379975, 0.540086893121109, 0.501490644242369, 0.510113727070204, 0.5096, 0.548782322947631, 0.521518359787994, 0.563986346994286, 0.49072802481969, 0.51555034201474, 0.498385937833626, 0.468167429258147, 0.492531561415001, 0.557860559674552, 0.489588028836284, 0.512076345318101, 0.567597273646117, 0.503394383614424, 0.534337205226146, 0.494497260872192, 0.575378615444744, 0.532901012658945, 0.586016857757315, 0.44800671712136, 0.535342059629244, 0.522874504131448, 0.564429952888019, 0.474064848310904, 0.502881508625215, 0.528572692171182, 0.534308156082766, 0.514627492621232, 0.494728698226093, 0.535787654304437, 0.490854527607444, 0.525166370945167, 0.505977802842869, 0.527102389762112, 0.547508075305974, 0.557342106644011, 0.462392022230296, 0.431087496801972, 0.526583129546734, 0.525077696607605, 0.50059226175127, 0.504826124281991, 0.482916558449017, 0.499412624687212, 0.486523017404774, 0.529581157161206, 0.481971479939163, 0.571911826219477, 0.499350461331842, 0.53346504282773, 0.558013567772489, 0.453396387771721, 0.509474343482247, 0.49561030634721, 0.44455917286883, 0.528660780279813, 0.51595662490938, 0.44855638430301, 0.43609916581466, 0.509295324617032, 0.53660180899261, 0.490510521927116, 0.476302363859536, 0.546106521595643, 0.493377771954297, 0.500115309531995, 0.494979626557569, 0.496767727769765, 0.499913534341872, 0.550945301873576, 0.493192910399863, 0.556366525509102 ]

## n3_mean = [ 8.56, 8.53, 8.48, 8.59, 8.74, 8.24, 8.67, 8.58, 8.35, 8.6, 8.23, 8.61, 8.41, 8.41, 8.51, 8.61, 8.74, 8.44, 8.93, 8.17, 8.73, 8.36, 8.66, 8.15, 8.32, 8.73, 8.83, 8.79, 8.74, 8.83, 9.03, 8.23, 9.21, 8.52, 8.33, 8.46, 8.22, 8.8, 8.27, 8.68, 8.76, 8.64, 8.61, 8.72, 8.78, 8.96, 8.7, 8.26, 9.12, 8.88, 8.7, 8.78, 8.73, 9.2, 8.73, 8.57, 8.75, 8.61, 8.53, 8.95, 8.32, 8.8, 8.57, 9.07, 8.49, 8.53, 8.71, 8.57, 9.11, 9.18, 8.01, 8.15, 8.2, 8.35, 8.44, 8.97, 8.79, 8.69, 8.66, 8.68, 8.97, 8.3, 8.37, 8.76, 8.86, 8.93, 8.17, 8.66, 8.86, 8.86, 8.44, 8.88, 8.87, 9.12, 8.81, 8.98, 9.14, 8.76, 8.54, 8.77 ]

## root_ages_ci_width_maxtaxa = [ 0.402583958506349, 0.35349828513856, 0.279136899947445, 0.335964859631695, 0.28499397804662, 0.350514303436294, 0.275736198280265, 0.455849583827377, 0.259865149105153, 0.316546126933438, 0.305578753591548, 0.303276427111832, 0.356803245109667, 0.349309953728566, 0.297484943682441, 0.265405747167443, 0.363236300308106, 0.295812793909584, 0.285125509359068, 0.310244618451754, 0.288206675600422, 0.336788789812009, 0.337736473094787, 0.272428124414821, 0.321512199607884, 0.267271492064018, 0.371021397380774, 0.352442900925604, 0.309540218809714, 0.355374796132488, 0.305623973266641, 0.302257792816758, 0.300967278683057, 0.266956700043462, 0.293744911020102, 0.256051629776374, 0.309583989206934, 0.324916435756151, 0.28976540917237, 0.298235293668219, 0.319584333981025, 0.271805481279532, 0.314020616539998, 0.313798716586409, 0.283627264545878, 0.296468492871938, 0.45298408408228, 0.306207593301471, 0.280898905689945, 0.341150709685206, 0.298711003193309, 0.333910311099175, 0.319905289354395, 0.33376613540649, 0.261567434000333, 0.37741849941295, 0.294467075077753, 0.307454704085834, 0.346391306063803, 0.290871500055408, 0.343205617473415, 0.350740045134609, 0.284444919739236, 0.246979986168107, 0.306765833389505, 0.309553536719499, 0.305167803383524, 0.254944666242712, 0.343337884707819, 0.283345167670977, 0.297222585093481, 0.333984832861718, 0.286609263763584, 0.308404383388671, 0.349809192412382, 0.414744183506743, 0.296773462063394, 0.27413513569572, 0.351391384158802, 0.26791640108123, 0.320410244823906, 0.299108070492746, 0.29918894547005, 0.309930051009676, 0.261255787898873, 0.28158359341994, 0.330409421230667, 0.306513711035209, 0.320042174273291, 0.317514715802498, 0.286335101220367, 0.36542235825688, 0.32304600165077, 0.294266905897255, 0.343132428237696, 0.30837395518183, 0.305561551256897, 0.262667767787128, 0.375723289860407, 0.323511383964665 ]

## root_ages_mean_maxtaxa = [ 5.08809704868853, 4.95753861326743, 4.73636284670131, 4.96319404849764, 4.73567730667835, 5.07163432338756, 4.62637335091147, 5.16307332294441, 4.76080447916564, 4.91593770775134, 4.67908259075116, 4.9157819421004, 4.90971719868318, 4.82118785285073, 4.76865206960806, 4.57380150527143, 4.84420190154827, 4.82351228903679, 4.75515935691569, 4.77691149408655, 4.77539392318328, 4.90003057814264, 4.80059210833242, 4.79140720380567, 4.62017727971943, 4.79818435964553, 4.89002658190016, 4.8802668875685, 4.82645552580452, 4.98041134655664, 4.64552965351449, 4.77548921944079, 4.90378277256892, 4.79361323760426, 4.77139635474947, 4.69246861709882, 4.74756168773244, 5.02304518811842, 5.09361908167418, 4.74091267199378, 4.69201783819571, 4.69175774995683, 4.83038879119169, 4.76759826602195, 4.79497437782467, 4.90607038574299, 5.09813837617416, 5.07873260639862, 4.8204596281595, 4.81986973522004, 4.85284012770134, 4.80575537576375, 5.00501395688113, 5.04013324930276, 4.75502249254939, 5.02559335276541, 4.73056759503486, 4.8574636391649, 4.95127186276422, 4.81535239685493, 4.74811431504154, 5.07250958068098, 4.74875653600774, 4.39826003370807, 4.81985408466801, 4.78999193814117, 4.95907610123399, 4.78060163162943, 4.79770442919843, 4.75592090276486, 4.93917652978045, 4.79632734760973, 4.71875674806222, 5.03755596934894, 5.01843915972029, 5.1153635330767, 4.80821484679762, 4.75670039780254, 4.75572626809253, 4.74002377788157, 4.8222321094791, 4.81827122346801, 4.92881100627846, 5.01322490498682, 4.76512822262139, 4.68956597661793, 4.99604570258193, 4.87552788348062, 4.82144322511717, 4.92249089073036, 4.86686357554131, 4.82568772352076, 4.8844156477878, 4.948674394934, 4.86740785611967, 4.8069211295702, 4.77484137489311, 4.77531869830951, 5.14516991704117, 4.8200173812382 ]


######## max.t ########
set.seed(123)
null.count <- 0
for (b in 1:n.batches) {
    null.count = 0 # in case we want to know anything about this later

    if (b %% 5 == 0) { cat("batch ", b, "\r") }

    for (i in 1:n.sim) {
        tr.max.t = NULL

        ## conditioning on speciation (done by default by diversitree)
        while (is.null(tr.max.t)) {
            tr.max.t = tree.classe(pars, max.t=max.age, x0=1, include.extinct=TRUE)

            if (!is.null(tr.max.t)) {
                ## conditioning on survival
                while (length(table(str_detect(tr.max.taxa$tip.label, "ex"))) <2) {
                    tr.max.t = tree.classe(pars, max.t=max.age, x0=1, include.extinct=TRUE)
                }

                trs.list.max.t[[b]][[i]] = tr.max.t # b-th batch, i-th tree with max.t
                ith.specs.df.max.t = get.specs(tr.max.t, w.states=TRUE, w.root=TRUE, three.states=TRUE)
                spec.df.max.t$ntotal[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.total"
                spec.df.max.t$root.age[(b-1) * n.batches + i] = ith.specs.df.max.t$"tr.h"
                spec.df.max.t$ntips[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.tips"
                spec.df.max.t$n1[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.0"
                spec.df.max.t$n2[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.1"
                spec.df.max.t$n3[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.2"
            } else {
                null.count = null.count + 1
            }
        }
    }
}

## getting stats (mean, stdev, stderr) for different tree specs
mean.df.max.t <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
sd.df.max.t <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
stderr.df.max.t <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
names(mean.df.max.t) <- names(sd.df.max.t) <- names(stderr.df.max.t) <- c("ntotal", "ntips", "n1", "n2", "n3", "root.age")
n1.ci.width.max.t <- n2.ci.width.max.t <- n3.ci.width.max.t <- root.age.ci.width.max.t <- rep(0.0, n.batches)
for (b in 1:n.batches) {
    bth.batch.df = spec.df.max.t[((b-1) * n.batches + 1):((b-1) * n.batches + n.sim),]
    mean.df.max.t[b,] = sapply(bth.batch.df, mean)
    sd.df.max.t[b,] = sapply(bth.batch.df, sd)
    stderr.df.max.t[b,] = sd.df.max.t[b,] / sqrt(n.sim)

    n1.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "n1"] # actually half width, which we use in unit test
    n2.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "n2"]
    n3.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "n3"]
    root.age.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "root.age"]
}

## getting means and 95-CI widths (for unit test)
cat("\nn1_ci_width_maxtaxa = [", paste(n1.ci.width.max.t, collapse=", "), "]\n")
cat("\nn1_mean = [", paste(mean.df.max.t$n1, collapse=", "), "]\n")
cat("\nn2_ci_width_maxtaxa = [", paste(n2.ci.width.max.t, collapse=", "), "]\n")
cat("\nn2_mean = [", paste(mean.df.max.t$n2, collapse=", "), "]\n")
cat("\nn3_ci_width_maxtaxa = [", paste(n3.ci.width.max.t, collapse=", "), "]\n")
cat("\nn3_mean = [", paste(mean.df.max.t$n3, collapse=", "), "]\n")
cat("\nroot_ages_ci_width_maxtaxa = [", paste(root.age.ci.width.max.t, collapse=", "), "]\n")
cat("\nroot_ages_mean_maxtaxa = [", paste(mean.df.max.t$root.age, collapse=", "), "]\n")

## n1_ci_width_maxtaxa = [ 1.19674351673551, 1.2545159984245, 1.43330374543105, 1.525735857039, 1.2868631434224, 1.61348924666107, 1.35574716811004, 1.29664261097885, 1.72168688292276, 1.62656741674365, 1.56975485134888, 1.27159761057983, 1.4961398173738, 1.42283831630422, 1.41081911245943, 1.61097167691998, 1.3402036787765, 1.98910373969603, 1.20308197089262, 1.61204561481443, 1.34301359846301, 1.57255187783578, 1.29361049888608, 1.57133612270101, 1.62091316525375, 1.46939801815491, 1.70465945223109, 1.44972430343138, 1.71947670263633, 1.82044933691735, 1.23045565740846, 1.69371948591545, 1.62437472862326, 1.35853350761515, 1.42820492488814, 1.64741315627706, 1.51673143731159, 1.67790149408074, 1.28742840632563, 1.43419146968498, 1.40938401674869, 1.47316558814717, 1.34064225766246, 1.6055078305444, 1.79308758663188, 1.6146960936187, 1.52562394773384, 1.38286145204628, 1.49206229241424, 1.47307075899636, 1.50873711909844, 1.24813562070665, 1.45228760598755, 1.70557885028674, 1.40232210251137, 1.58637743174807, 1.37310823927601, 1.77487625700407, 1.53768328220204, 1.58062483182756, 1.38158129224114, 1.58885215616224, 1.62883219789176, 1.43449446921981, 1.3181666968969, 1.79365016194194, 1.100375279235, 1.16185005726021, 1.37891188253564, 1.39777803471919, 1.32327897545026, 1.64445086643573, 1.30699180803195, 1.61065248789665, 1.3318155603794, 1.36817081809062, 1.37633597671792, 1.34039910293596, 1.33643292749654, 1.45266563422161, 1.37963773081299, 1.37016604700439, 1.3546018088745, 1.17704882522761, 1.41378649053104, 1.45917020836148, 1.20789751120522, 1.28608946136195, 1.36678463289842, 1.74408965574386, 1.4103239424424, 1.39271075317892, 1.55072514337746, 1.61064285101799, 1.50469888930468, 1.40661150775094, 1.39243628307519, 1.37052708816497, 1.96641986987684, 1.41372061646357 ]

## n1_mean = [ 7.54, 7.61, 7.59, 7.36, 7.94, 8.48, 6.95, 6.85, 8.47, 8.28, 8.59, 7.49, 7.88, 8.22, 6.81, 8.14, 7.82, 8.41, 7.86, 8.52, 8.09, 8.46, 7.43, 7.99, 8.54, 8.09, 9.12, 8.41, 7.87, 8.34, 7.23, 8.45, 9.11, 7.76, 8.21, 8.86, 8.66, 7.87, 7.19, 7.75, 7.48, 7.82, 8.11, 8.45, 7.94, 8.5, 8.72, 7.83, 7.78, 7.86, 9.17, 7.56, 8.08, 7.56, 7.89, 7.69, 7.54, 9.09, 8.92, 8.66, 7.99, 8.94, 9.22, 8.01, 7.39, 8.54, 6.42, 6.75, 6.2, 7.5, 6.29, 8.53, 7.41, 9.19, 7.3, 6.98, 8.27, 7.83, 7.85, 6.59, 8.22, 8.14, 7.55, 6.42, 7.49, 8.5, 6.98, 7.57, 7.91, 8.7, 7.39, 7.12, 7.22, 8.87, 7.45, 7.54, 8.29, 7.71, 8.48, 8.43 ]

## n2_ci_width_maxtaxa = [ 1.35186190436925, 1.36656458687506, 1.25987426084166, 1.57463807019938, 1.53247597427078, 1.73934865040818, 1.64778998563763, 1.47029693970609, 1.70682061616257, 1.89027769602268, 1.83399406275544, 1.22761410776178, 1.6395176013854, 1.43739272604563, 1.64850454716394, 1.48112921104068, 1.61457593018831, 2.22204158049631, 1.53369090745038, 1.81364866910587, 1.71610295846153, 1.87175776037802, 1.49697472701891, 1.83510559011428, 1.61152559076701, 1.71730887004974, 1.41594765354365, 1.5389546203954, 1.7915634190406, 1.79236788206173, 1.41781133705255, 1.73279403218611, 2.01567699993843, 1.59569409437658, 1.45370837529542, 1.77728501332393, 1.85851750890571, 1.5480553765576, 1.58162124007953, 1.56933084935825, 1.42858525143096, 1.49078089820894, 1.81157639439447, 1.6741508040638, 1.7379280690907, 1.40577123589749, 1.7265573003857, 1.25637051666756, 1.48022769255888, 1.82444376845175, 1.73509571755881, 1.44792447763317, 1.64053855606608, 1.69218836929336, 1.29018634375665, 1.57290593629894, 1.58510618450677, 1.8766026229451, 1.87850401859533, 1.67982567445722, 1.52043020971903, 1.55697833438278, 1.81060902126295, 1.29431972631935, 1.50871782931231, 1.67823448308096, 1.52592277814065, 1.53323921661088, 1.40221141304323, 1.49493979122704, 1.39776554210893, 1.94219099061869, 1.42041310764286, 1.73104642562722, 1.76911366543027, 1.66047535557281, 1.45995582664599, 1.5232923323174, 1.51447837284597, 1.69277530819669, 1.59233467828744, 1.78585793365316, 1.35429955894312, 1.50612174592075, 1.4238947248567, 1.90632932976843, 1.23983820645349, 1.48298424547371, 1.84567428799714, 1.57646060848377, 1.62001757616104, 1.63318602972128, 1.75816093079839, 1.7483384661796, 1.61433557649435, 1.85817819371447, 1.68012017415302, 1.26823794090363, 2.0212521147831, 1.55664807412166 ]

## n2_mean = [ 7.94, 7.56, 7.93, 7.32, 9.72, 9.66, 7.26, 7.9, 9.62, 9.59, 9.2, 7.73, 8.22, 8.66, 8.63, 7.81, 8.4, 9.67, 9.32, 9.85, 9.16, 10.44, 7.9, 8.43, 9.44, 8.83, 8.45, 8.16, 8.38, 9.01, 8.58, 9.39, 9.66, 8.61, 8.4, 9.24, 9.92, 8.04, 7.88, 8.18, 8.19, 7.87, 9.81, 8.47, 8.23, 8.85, 9.41, 8.11, 8.57, 8.98, 10.58, 8.35, 8.61, 8.19, 7.73, 7.77, 7.9, 9.16, 10.04, 9.02, 8.81, 8.74, 9.58, 7.74, 7.98, 8.59, 8.07, 8.59, 6.99, 8.37, 7.03, 9.53, 7.69, 9.59, 8.62, 7.81, 8.03, 8.04, 9.46, 7.43, 8.59, 9.48, 7.56, 8.11, 8.53, 10.26, 7.16, 8.38, 9.82, 9.12, 8.08, 8.32, 7.4, 9.74, 8.8, 8.83, 8.93, 8.1, 9.66, 10.21 ]

## n3_ci_width_maxtaxa = [ 0.438087780512471, 0.456891908176951, 0.451458017780371, 0.487236327450939, 0.499727208008772, 0.554217702913054, 0.48162918633666, 0.40394909370245, 0.50595862968181, 0.488099668576661, 0.46623637131759, 0.429793850513701, 0.513136138432733, 0.510174578953226, 0.497637926061253, 0.500095911609044, 0.551198797846543, 0.585351002701487, 0.45637778963123, 0.519822869598458, 0.480681576703142, 0.470069917859852, 0.448037031297795, 0.560289823991733, 0.503991436515352, 0.482116378087492, 0.486586819518668, 0.592274028851954, 0.531103050359354, 0.533290439184177, 0.378728471268658, 0.551462732240815, 0.507218678558655, 0.530254840962, 0.440547714197734, 0.517724742590992, 0.452724045098227, 0.570298119452015, 0.470610306523413, 0.434713327110726, 0.395920196019553, 0.413879881076135, 0.522666666666667, 0.617583025621133, 0.520922772538785, 0.471537009698233, 0.519610077584406, 0.433712423458939, 0.497013722957506, 0.569481033995697, 0.565130758445702, 0.460360887859413, 0.505344704437506, 0.468962449876255, 0.455190129661677, 0.505590363992053, 0.413255928236029, 0.564086102747738, 0.641997660085732, 0.509188645163692, 0.423390062531592, 0.486538968717623, 0.593645024021472, 0.448768280627062, 0.531866011835175, 0.600291463214396, 0.420668451228026, 0.444580993972999, 0.465090574865029, 0.479598613320545, 0.5095048085141, 0.548262362912008, 0.51547130537661, 0.472486534039315, 0.552394290449505, 0.43004206324686, 0.466173945945918, 0.453819836988694, 0.449735678151089, 0.523034037558211, 0.402259677925651, 0.395763349347648, 0.512833563880548, 0.364910872749093, 0.501738190813907, 0.575159390820045, 0.33626045460823, 0.372191541868409, 0.509889272986862, 0.560068157468447, 0.514435181102105, 0.465257411536774, 0.48127455529641, 0.423751928573425, 0.535758683805244, 0.46978503573228, 0.513695431519141, 0.494041915368943, 0.645674134904635, 0.476575208009071 ]

## n3_mean = [ 1.79, 2.02, 2.26, 2.11, 2.38, 2.38, 1.89, 1.93, 2.27, 2.02, 2.41, 2.14, 2.12, 2.35, 1.91, 2.43, 2.48, 2.49, 2.05, 2.42, 2.16, 2.16, 2.13, 2.3, 2.29, 2.3, 2.28, 2.6, 2.03, 2.53, 1.94, 2.23, 2.5, 2.21, 2.28, 2.45, 2.41, 2.28, 1.75, 1.9, 1.98, 1.84, 2.6, 2.53, 2.13, 2.3, 2.61, 2.18, 2.29, 2.32, 2.64, 2.28, 2.17, 1.82, 2.02, 2.05, 1.83, 2.4, 2.72, 2.28, 2.02, 2.14, 2.59, 2.1, 2.3, 2.44, 2.14, 2.08, 1.84, 2.18, 2.01, 2.56, 2.35, 2.37, 2.42, 1.79, 2.14, 1.95, 2.26, 2.01, 2.1, 2.06, 2.32, 1.78, 2.25, 2.57, 1.81, 1.99, 2.2, 2.42, 2, 2.04, 1.97, 2.05, 2.27, 2.15, 2.14, 2.3, 2.42, 2.13 ]

## root_ages_ci_width_maxtaxa = [ 0.12692952540925, 0.139613278777909, 0.109372133047407, 0.13921837456182, 0.130103817029074, 0.12840913500313, 0.135702021259288, 0.145513306197362, 0.150240697805724, 0.136045062144244, 0.131087019568962, 0.126804012902848, 0.162174213602609, 0.118286685685816, 0.134569812219664, 0.114935903194279, 0.144151991158098, 0.144582552987022, 0.142140594220997, 0.127828897449516, 0.114272855840606, 0.117214680734728, 0.141983187822582, 0.132333333755836, 0.149592079996444, 0.137316210918328, 0.120096073307902, 0.123477608172767, 0.124910846181645, 0.143964549733037, 0.132569541138113, 0.117359210632105, 0.123529536451926, 0.144760437070485, 0.129531155099021, 0.136388571197958, 0.119949736989869, 0.14769593405573, 0.163781345655721, 0.137148548436855, 0.126659086897886, 0.150358423016841, 0.133122251033155, 0.137773076016279, 0.118696887877621, 0.141163096602117, 0.125634750872414, 0.116721853474592, 0.133018580251566, 0.131543450078212, 0.137691248438227, 0.134808180391327, 0.136716579182557, 0.133689988682135, 0.12458963205751, 0.143071942728272, 0.135218790423002, 0.128251528916036, 0.137629123534693, 0.125605979715581, 0.12974569709136, 0.136974297749045, 0.144979153807272, 0.133947431567988, 0.162198439495914, 0.130786968579638, 0.121711800350963, 0.131630822067461, 0.143683000144826, 0.135341387790975, 0.142369985472937, 0.127998164562652, 0.140335873071315, 0.149482608458925, 0.144721086492454, 0.139700107998867, 0.132567441706095, 0.127813309102368, 0.109946699354391, 0.142354789594405, 0.135482260271418, 0.128255235865071, 0.139364713914018, 0.142113974347538, 0.135827563839668, 0.124961026953989, 0.139300047992765, 0.133679671667615, 0.116341401356578, 0.161942912435866, 0.152143911819712, 0.137530614439772, 0.156173156758097, 0.134162533913284, 0.124308565664, 0.144581241284565, 0.122850528054223, 0.134561134236951, 0.131863194311972, 0.129588495403706 ]

## root_ages_mean_maxtaxa = [ 2.30377832723862, 2.20167662640125, 2.39642037011796, 2.18675638484214, 2.34127075710877, 2.28923877812535, 2.26994948684771, 2.20526460927574, 2.28081926157237, 2.24673458487209, 2.36760192753108, 2.38237932086301, 2.15922109041031, 2.37026031935458, 2.15352354984275, 2.36563301173885, 2.23545011262783, 2.16473497963318, 2.27202660871667, 2.33970854822697, 2.36897102719439, 2.34310561113993, 2.25327013030979, 2.32036037211262, 2.24623415370481, 2.20779920139833, 2.27324547965023, 2.33040604856689, 2.25541116116714, 2.15750551391841, 2.31626564921671, 2.31553029279107, 2.33529654351746, 2.2549026248901, 2.20465363473376, 2.18380132620389, 2.37074842169708, 2.19660982150253, 2.13099352201886, 2.27358879272019, 2.23690007630279, 2.22599732138642, 2.34045326859406, 2.21320543364603, 2.25512605256691, 2.29794388858916, 2.29090556838208, 2.3479702401512, 2.23472756175958, 2.26624022364857, 2.26648453019035, 2.28020943365781, 2.1958107052627, 2.19221488487551, 2.23472952984318, 2.21472008265084, 2.26691225625441, 2.27938931641737, 2.2179135987607, 2.24505762234362, 2.28600476065899, 2.27710792307573, 2.25044910231106, 2.20586743170661, 2.17862500438784, 2.25731446121052, 2.31840181195581, 2.30338685556503, 2.1410242363329, 2.1475598669109, 2.24440782767709, 2.22878519017917, 2.16784150867132, 2.21378602387227, 2.17325351368281, 2.14361639210152, 2.30139999552004, 2.25351862317179, 2.38879858829186, 2.13914458245415, 2.26877368080396, 2.29778909094639, 2.23707054599823, 2.18505836877182, 2.19261838722073, 2.35482199587891, 2.13165555798845, 2.32855301315135, 2.30877278900578, 2.15730049114836, 2.08863023542047, 2.15087912576412, 2.14911084468646, 2.2204544036158, 2.28541977098519, 2.19151783110798, 2.33059151300222, 2.26478548094598, 2.26189328022624, 2.34903406859452 ]
