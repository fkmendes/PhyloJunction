library(phytools)
library(FossilSim)

source("unittest_R_utils.R")

## FBD
## params
b.rate <- 1.0
d.rate <- 0.5
f.rate <- 0.75

## simulation specs
n.batches <- 100
n.sim <- 100
size.tr <- 10 # for simulations with sim.fbd.taxa
max.age <- 3.0 # for simulations with sim.fbd.age

## storing things
trs.list.max.taxa <- rep(list(vector(mode="list", length=n.sim)), n.batches) # store trees with different ages, same number of extant taxa
spec.df.max.taxa <- as.data.frame(matrix(rep(0, n.batches * n.sim * 4), nrow=n.batches * n.sim))

trs.list.max.t <- rep(list(vector(mode="list", length=n.sim)), n.batches) # store trees with different numbers of extant taxa, same origin age (but different root age)
spec.df.max.t <- as.data.frame(matrix(rep(0, n.batches * n.sim * 4), nrow=n.batches * n.sim))

names(spec.df.max.taxa) <- names(spec.df.max.t) <-  c("ntotal", "ntips", "root.age", "n.sa")


######## max.taxa ########
## suspended until PJ has GSA implemented
## set.seed(123)
## null.count <- 0
## for (b in 1:n.batches) {
##     null.count = 0 # in case we want to know anything about this later

##     if (b %% 5 == 0) { cat("batch ", b, "\r") }

##     # no rejection sampling required
##     trs.max.taxa = sim.fbd.taxa(size.tr, n.sim, b.rate, d.rate, f.rate)

##     for (i in 1:n.sim) {
##         tr.max.taxa = trs.max.taxa[[i]]

##         ## conditioning on speciation and survival
##         ## (FossilSim only returns "valid" trees, which means having size.tr extant tips)
##         trs.list.max.taxa[[b]][[i]] = tr.max.taxa # b-th batch, i-th tree with max.taxa
##         ith.specs.df.max.taxa = get.specs(tr.max.taxa, w.states=FALSE, w.sa=TRUE)
##         spec.df.max.taxa$root.age[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"tr.h"
##         spec.df.max.taxa$ntotal[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"n.total"
##         spec.df.max.taxa$ntips[(b-1) * n.batches + i] = ith.specs.df.max.taxa$"n.tips"
##         spec.df.max.taxa$n.sa[(b-1) * n.batches + i] = get.n.sa(tr.max.taxa)
##     }
## }

## ## getting stats (mean, stdev, stderr) for different tree specs
## mean.df.max.taxa <- data.frame(matrix(rep(0.0, 4 * n.batches), nrow=n.batches))
## sd.df.max.taxa <- data.frame(matrix(rep(0.0, 4 * n.batches), nrow=n.batches))
## stderr.df.max.taxa <- data.frame(matrix(rep(0.0, 4 * n.batches), nrow=n.batches))
## names(mean.df.max.taxa) <- names(sd.df.max.taxa) <- names(stderr.df.max.taxa) <- c("ntotal", "ntips", "root.age", "n.sa")
## root.age.ci.width.max.taxa <- n.sa.ci.width.max.taxa <- rep(0.0, n.batches)
## for (b in 1:n.batches) {
##     bth.batch.df.all = spec.df.max.taxa[((b-1) * n.batches + 1):((b-1) * n.batches + n.sim),]
##     bth.batch.df = bth.batch.df.all[bth.batch.df.all$ntips==size.tr,] # for max taxa
##     ## bth.batch.df = bth.batch.df.all ## for max age
##     mean.df.max.taxa[b,] = sapply(bth.batch.df, mean)
##     sd.df.max.taxa[b,] = sapply(bth.batch.df, sd)
##     stderr.df.max.taxa[b,] = sd.df.max.taxa[b,] / sqrt(n.sim)

##     root.age.ci.width.max.taxa[b] = 1.96 * stderr.df.max.taxa[b, "root.age"]
##     n.sa.ci.width.max.taxa[b] = 1.96 * stderr.df.max.taxa[b, "n.sa"]
## }

## ## getting means and 95-CI widths (for unit test)
## cat("\nn_sa_mean_maxtaxa = [", paste(mean.df.max.taxa$n.sa, collapse=", "), "]\n")
## cat("\nn_sa_ci_width_maxtaxa = [", paste(n.sa.ci.width.max.taxa, collapse=", "), "]\n")
## cat("\nroot_ages_mean_maxtaxa = [", paste(mean.df.max.taxa$root.age, collapse=", "), "]\n")
## cat("\nroot_ages_ci_width_maxtaxa = [", paste(root.age.ci.width.max.taxa, collapse=", "), "]\n")

## n_sa_mean_maxtaxa = [ 11.79, 11.43, 12.31, 11.86, 13.68, 11.66, 11.75, 11.7, 11.82, 12.38, 11.98, 12.36, 11.95, 12.93, 11.88, 11.39, 11.44, 11.86, 13.44, 10.6, 12.51, 10.84, 11.73, 12.21, 11.81, 11.73, 12.26, 12.11, 12, 12.6, 11.77, 12.97, 12.35, 11.2, 11.58, 11.06, 11.66, 12.77, 12.48, 11.33, 11.79, 10.97, 13.07, 11.86, 12.33, 12.28, 13.29, 11.29, 12.66, 11.6, 12.35, 11.26, 11.77, 11.69, 11.92, 11.3, 12.24, 11.4, 12.84, 11.8, 11.34, 12.29, 12.21, 12.32, 11.44, 11.65, 13.44, 12.05, 12.22, 11.61, 11.89, 10.98, 11.78, 11.9, 12.22, 13.22, 9.65, 12.55, 11.21, 12.72, 11.86, 10.57, 12.34, 11.67, 12.22, 11.75, 12.85, 11.86, 11.55, 12.26, 11.82, 12.35, 11.59, 12.7, 11.93, 12.52, 11.47, 12.49, 11.33, 12.63 ]

## n_sa_ci_width_maxtaxa = [ 1.33379389560741, 1.24593720418313, 1.56990316319771, 1.11572807519475, 1.12088433773778, 1.20861690315247, 1.23313962442756, 1.28887585503685, 1.20931019723283, 1.27989681149724, 1.2932279844629, 1.32948845877661, 1.17248886622183, 1.41481811716081, 1.28519152744726, 1.18057597926956, 1.32504457801893, 1.31732008581242, 1.39633926241354, 1.14048736702492, 1.39471956502033, 1.11144201101019, 1.30216129336553, 1.20928292233977, 1.30062271891956, 1.14213804186126, 1.51504195308115, 1.22572874485328, 1.4264935607243, 1.37016038285577, 1.37718152878708, 1.19350802242631, 1.3215418451509, 1.47464518588114, 1.19504325503897, 1.25170581886068, 1.34910349222262, 1.68878193914425, 1.42961298485452, 1.17568814046769, 1.19637868333542, 1.18698769304249, 1.53782837886036, 1.21750969813407, 1.30905657199636, 1.22356935449223, 1.30705118584707, 1.29960793404096, 1.25677968722534, 1.44218465033316, 1.30350754473916, 1.20327547850512, 1.25295608184417, 1.08421663868249, 1.4198625262804, 1.2987731273643, 1.26536470504265, 1.40318103254748, 1.44640815676613, 1.40179763377622, 1.23025538549333, 1.34162600518094, 1.2137669947629, 1.32900970255862, 1.17643547492698, 1.21347283580323, 1.59701279932633, 1.10009136443343, 1.27223370955071, 1.25760534285754, 1.44538162672309, 1.10838639362623, 1.2651990962419, 1.30800234763327, 1.27680062023731, 1.49751380007469, 0.910574177831402, 1.51625933924193, 1.3502750690212, 1.33721810796999, 1.00406398765872, 1.2727444940249, 1.42246736498397, 1.20083338805123, 1.23477643075149, 1.25311711545669, 1.33410806280163, 1.18717238389836, 1.43094101975595, 1.33650406265561, 1.14265604181617, 1.40466666666667, 1.25920880658684, 1.27403807246919, 1.31680007057206, 1.37707586317141, 1.31980242843428, 1.29847282418675, 1.15739282838279, 1.27894901992048 ]

## root_ages_mean_maxtaxa = [ 3.06158475192417, 3.32709888885735, 3.1214987606465, 3.2038958126961, 3.03141896233894, 3.46974124531352, 3.50598379407897, 3.17238009650997, 3.2730016625159, 3.28443930284859, 3.42614433739572, 3.1799702838571, 3.19976981581782, 3.47522343843126, 3.183949056896, 3.16728712301645, 3.28761041840292, 3.11426523229198, 3.58531310345, 2.94317680635375, 3.29449840365967, 3.28878994083599, 3.23802550455375, 3.22190113550461, 3.36282308204269, 3.54382048378497, 3.20440286112108, 3.3090674701662, 3.34275889007505, 3.12691938172564, 3.33182999768509, 3.43457794037564, 3.27309332225342, 3.20495251252992, 3.43589418010246, 3.24701970302327, 3.28278784848371, 3.44945343469407, 3.19295764870201, 3.22819435797767, 3.28178198407458, 3.39723970249208, 3.60982901913729, 3.33668733806059, 3.44476782122808, 3.32025918256223, 3.51571270353605, 2.98238129728412, 3.46001154879427, 3.34857910267609, 3.58346899764418, 3.42406958205434, 3.50028638328715, 3.23462859507321, 3.26271504845709, 3.40853305622832, 2.97400800063136, 3.16754353212038, 3.64684379585319, 3.58176312946842, 3.1133520652582, 3.19872729959642, 3.12828002043412, 3.32382912239342, 3.26820188009603, 3.37489591781346, 3.62748409916923, 3.29571394856256, 3.30896200621846, 3.06386390733467, 3.32127490587135, 3.10097762840498, 3.20307109196218, 3.33146391677673, 3.26885893364074, 3.48889690295416, 2.64522072444859, 3.66406943536744, 3.05953473561372, 3.20892751670681, 3.51632147125951, 3.168446136035, 3.15701055536265, 3.23219303029446, 3.25490487429717, 3.31696905343935, 3.25640838754555, 3.04585612546581, 3.01576569359621, 3.90536299984387, 3.52072820067763, 3.2701692005532, 3.56062136501843, 3.36883225323135, 3.12855041294481, 3.53681433150419, 3.05565680557827, 3.54836816485227, 2.85258012676722, 3.53368111295637 ]

## root_ages_ci_width_maxtaxa = [ 0.408647553505562, 0.509592298750689, 0.38409696476414, 0.409577052775503, 0.343181507630708, 0.425925871023221, 0.440410622940826, 0.373512788035978, 0.423466332276909, 0.446359844966612, 0.39550978128479, 0.362226738238393, 0.433430020093021, 0.441539771069205, 0.386224196961461, 0.416661593610685, 0.476251662617177, 0.394567481807831, 0.401871801250315, 0.377139877102328, 0.361005260062301, 0.47457693912755, 0.494768499892774, 0.364915372943971, 0.420463635827272, 0.470143983528569, 0.395008062847314, 0.450118684986919, 0.473402295787168, 0.374673879265125, 0.435951339487528, 0.422889389606616, 0.400228202075088, 0.427262159720166, 0.469923951198503, 0.418199242842914, 0.391065817814109, 0.473126296469968, 0.482313867304151, 0.467750693540001, 0.417134096093507, 0.460851228415337, 0.548406647618856, 0.402711017600549, 0.473654696487989, 0.449154692120125, 0.403322820470335, 0.454830338414632, 0.453998441357947, 0.485982655331107, 0.421788588327507, 0.441012302705562, 0.493085692361023, 0.3967052365066, 0.400791691564759, 0.462200455705074, 0.372325916558093, 0.437067833644792, 0.469982650720636, 0.549914384317812, 0.376250577728838, 0.399247826476163, 0.381805266058534, 0.399376308077217, 0.419076282996469, 0.406647571777729, 0.503686696621813, 0.402734834181398, 0.409564416715385, 0.414961924085472, 0.482648165564663, 0.379673919691292, 0.40496599740129, 0.438897720965336, 0.420990053026926, 0.501251156477642, 0.301854144258771, 0.483862166647989, 0.418853230258794, 0.395362614193838, 0.365611355058353, 0.532996409564814, 0.387043185904377, 0.403102021917312, 0.358345071423213, 0.360662145626226, 0.394681747797261, 0.346148061927539, 0.414274968052868, 0.525565802883034, 0.473154548027078, 0.456245337946746, 0.430655387821212, 0.362858201816026, 0.424946940315028, 0.444499780064382, 0.431266924028455, 0.399629131019165, 0.355152164986533, 0.473725519301307 ]


######## max.t ########
set.seed(123)
null.count <- 0
for (b in 1:n.batches) {
    null.count = 0 # in case we want to know anything about this later

    if (b %% 5 == 0) { cat("batch ", b, "\r") }

    ## conditioning on survival with FossilSim
    trs.max.t = list(vector(mode="list", length=n.sim))
    j = 1
    while (j <= 100) {
        tr.max.t = sim.fbd.age(max.age, 1, b.rate, d.rate, f.rate, frac=1, complete=TRUE, mrca=FALSE)

        if (class(tr.max.t) == "list" && class(tr.max.t[[1]][1]) == "list") {
            trs.max.t[[j]] = tr.max.t[[1]]
            ## print(tr.max.t[[1]])
            j = j + 1
        }
    }

    for (i in 1:n.sim) {
        tr.max.t = trs.max.t[[i]]
        trs.list.max.t[[b]][[i]] = tr.max.t # b-th batch, i-th tree with max.t
        ith.specs.df.max.t = get.specs(tr.max.t, w.states=FALSE, w.sa=TRUE, w.root=FALSE)
        spec.df.max.t$root.age[(b-1) * n.batches + i] = ith.specs.df.max.t$"tr.h"
        spec.df.max.t$ntotal[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.total"
        spec.df.max.t$ntips[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.tips"
        spec.df.max.t$n.sa[(b-1) * n.batches + i] = get.n.sa(tr.max.t)
    }
}

## getting stats (mean, stdev, stderr) for different tree specs
mean.df.max.t <- data.frame(matrix(rep(0.0, 4 * n.batches), nrow=n.batches))
sd.df.max.t <- data.frame(matrix(rep(0.0, 4 * n.batches), nrow=n.batches))
stderr.df.max.t <- data.frame(matrix(rep(0.0, 4 * n.batches), nrow=n.batches))
names(mean.df.max.t) <- names(sd.df.max.t) <- names(stderr.df.max.t) <- c("ntotal", "ntips", "root.age", "n.sa")
root.age.ci.width.max.t <- n.sa.ci.width.max.t <- rep(0.0, n.batches)
for (b in 1:n.batches) {
    bth.batch.df = spec.df.max.t[((b-1) * n.batches + 1):((b-1) * n.batches + n.sim),]
    mean.df.max.t[b,] = sapply(bth.batch.df, mean)
    sd.df.max.t[b,] = sapply(bth.batch.df, sd)
    stderr.df.max.t[b,] = sd.df.max.t[b,] / sqrt(n.sim)

    root.age.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "root.age"]
    n.sa.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "n.sa"]
}

## getting means and 95-CI widths (for unit test)
cat("\nn_sa_mean_maxt = [", paste(mean.df.max.t$n.sa, collapse=", "), "]\n")
cat("\nn_sa_ci_width_maxt = [", paste(n.sa.ci.width.max.t, collapse=", "), "]\n")
cat("\nroot_ages_mean_maxt = [", paste(mean.df.max.t$root.age, collapse=", "), "]\n")
cat("\nroot_ages_ci_width_maxt = [", paste(root.age.ci.width.max.t, collapse=", "), "]\n")

## n_sa_mean_maxt = [ 9.56, 8.73, 8.35, 9.66, 9.86, 9.6, 9.49, 8.24, 8.15, 8.41, 9.31, 9.07, 8.43, 8.8, 6.8, 9.44, 8.42, 9.07, 9.23, 10.48, 9.77, 7.74, 10.14, 9.47, 9.18, 9.19, 8.49, 9.78, 10, 8.84, 7.85, 9.2, 9, 8.37, 8.69, 9.59, 8.72, 9.04, 9.41, 8.7, 7.57, 7.82, 9.13, 9.79, 10.82, 9.63, 8.17, 8.86, 10.01, 8.02, 7.87, 9.29, 9.34, 9.22, 8.65, 9.6, 9.82, 8.42, 8.25, 10.01, 9.47, 9.4, 9.95, 7.54, 8.73, 9.75, 9.93, 9.48, 8.5, 10.7, 9.47, 7.48, 8.4, 9.49, 8.81, 8.12, 7.91, 7.54, 8.96, 8.33, 8.65, 9.75, 9.68, 8.55, 9.57, 8.53, 8.82, 10.95, 8.79, 9.13, 9.8, 8.11, 8.95, 9.14, 9.83, 8.81, 8.2, 9.5, 7.66, 9.24

## n_sa_ci_width_maxt = [ 1.57622429004417, 1.22349799634928, 1.28763334702222, 1.67618115459824, 1.52891167683276, 1.51385819225667, 1.59681232915626, 1.12131353277657, 1.21379257043385, 1.24245662095282, 1.32456860993466, 1.64605467759007, 1.29899868259122, 1.30339590642632, 0.848647741939487, 1.24595744791714, 1.19990399346587, 1.33610768996811, 1.24331831723811, 1.33733417686308, 1.50146668819444, 1.21099042794138, 1.3965337777237, 1.44499497940479, 1.50186075885546, 1.15492259673298, 1.25377342305683, 1.4591914827857, 1.67983029445888, 1.29494915870715, 1.44201647533983, 1.24429948650685, 1.38312660010542, 1.41025790663705, 1.54699596233305, 1.52027707150421, 1.25642765414528, 1.50921671248781, 1.33140613388002, 1.33006623971147, 1.16780643961405, 1.14469179902167, 1.27712728837304, 1.47918921771969, 1.57155465766234, 1.50296489794155, 1.17568814046769, 1.27023128666246, 1.34226216349697, 1.06736643410146, 1.10230431259964, 1.64818438656639, 1.29119801484333, 1.80403906696931, 1.29514541908067, 1.3808803516071, 1.40770352480108, 1.14156882022642, 1.33759384453177, 1.75230129737088, 1.44392041583763, 1.78966072062542, 1.46603505683827, 1.00344544546288, 1.31402711778054, 1.39746568595953, 1.62994555328289, 1.60480797605196, 1.25840887190487, 1.52751004890146, 1.56836003442314, 1.27585813213434, 1.18028176742041, 1.45277247949282, 1.23701036733282, 1.29301792842649, 1.13813557907819, 1.29275981285673, 1.6672910268099, 1.32438110478331, 1.46471102400384, 1.5246812947318, 1.64643771000585, 1.22080554627598, 1.46732616081845, 1.28191894731092, 1.33846532108889, 1.66832754819934, 1.51239514851527, 1.42067534431319, 1.68029223047599, 1.24239415596979, 1.56784532065346, 1.43922729212027, 1.48148547400809, 1.3460727997483, 1.20146173598259, 1.44420122272389, 1.06890677202117, 1.49142238338325 ]

## root_ages_mean_maxt = [ 2.38366417139404, 2.26615642051174, 2.29884814593732, 2.34319135802387, 2.30531653051718, 2.20545251810196, 2.27447065726496, 2.32239234552556, 2.25607107827111, 2.32211751895091, 2.37952066965928, 2.3173093272037, 2.37465571232764, 2.37183161929928, 2.30471754871234, 2.43816409639795, 2.36059092928566, 2.43390279468663, 2.38232248137719, 2.41715008765125, 2.34640735126263, 2.25027910543559, 2.40834882562394, 2.41269512761795, 2.29759679613712, 2.37162834997766, 2.30683456339556, 2.3974272556093, 2.37777730683781, 2.31736769418913, 2.33926033265122, 2.34683059987156, 2.29919055639335, 2.29952418743682, 2.39068376550115, 2.30738423115837, 2.4570738071157, 2.42941813035316, 2.34424512582289, 2.26253949740992, 2.36782879841323, 2.3521675671179, 2.37370624566779, 2.380202603813, 2.44488733800071, 2.35086178444249, 2.44422217802661, 2.40403700842255, 2.44012025078346, 2.29854223695015, 2.39087134015631, 2.3091933640457, 2.36665381711774, 2.2726937198092, 2.27661941118283, 2.31968496265258, 2.3155811217305, 2.32310267116237, 2.27482730441775, 2.33210792621038, 2.39265551613513, 2.41343698564524, 2.38306926453957, 2.32035198852619, 2.32813429086543, 2.48211288264269, 2.35236607042751, 2.28842650494241, 2.25189889378323, 2.4066149647916, 2.34775538181992, 2.27872815738236, 2.23724297390451, 2.32609428065826, 2.36578487901597, 2.3523509671141, 2.22649453744094, 2.29937247130154, 2.22490395826341, 2.27926207982628, 2.3027658651316, 2.33315857575794, 2.30739468710185, 2.3470409763579, 2.35613153211857, 2.24839377618693, 2.3741445695071, 2.45614703318293, 2.37054526030235, 2.39808966833028, 2.36546295861751, 2.27631512497324, 2.26860948389909, 2.39696502331146, 2.31670146868658, 2.31528162539359, 2.26796780515744, 2.47311972707381, 2.30022715489888, 2.33487333561942 ]

## root_ages_ci_width_maxt = [ 0.120686995522846, 0.129156792405392, 0.12613483330819, 0.122613587372116, 0.122050275350315, 0.130636705421805, 0.116992493091365, 0.120010906523596, 0.147955699426646, 0.126754757452484, 0.104255053599428, 0.116532093465973, 0.105508158848639, 0.10487191897401, 0.122595304390188, 0.106357697597291, 0.108591964947324, 0.117301788446831, 0.112587871953908, 0.112741571771597, 0.114828590253191, 0.140856411965727, 0.106706364060663, 0.113488572167187, 0.135832198096519, 0.106245030796297, 0.125570490788327, 0.111768594202013, 0.11463782500689, 0.130322825881461, 0.118413208578857, 0.104421097137126, 0.117824808904298, 0.105881655723213, 0.109074761228308, 0.128488631876412, 0.100781365411774, 0.102610763773376, 0.112463724421251, 0.110425321436047, 0.110664541708584, 0.112015661649281, 0.131090960708247, 0.111976426672395, 0.103891220383613, 0.113850620461398, 0.109230124881383, 0.099802434333246, 0.115571383361228, 0.115674480948108, 0.118394064964809, 0.110938265051153, 0.127783994062688, 0.122497744797376, 0.124482379026199, 0.12346457224317, 0.116363348780944, 0.103766063669536, 0.115449383873525, 0.12577007207312, 0.117651917786888, 0.105079038445749, 0.115918517564665, 0.113523273421784, 0.126768929573245, 0.106076104074851, 0.114653778429165, 0.13538295957738, 0.142059337381011, 0.119141184048604, 0.10483380103667, 0.127815794407722, 0.143563176589759, 0.121832791035764, 0.108104713897136, 0.111948597672012, 0.140092974729279, 0.11515903583842, 0.123081105582667, 0.133272715793624, 0.121880013528989, 0.1108907552003, 0.115950895173066, 0.11334004114695, 0.112492213408179, 0.137926538786301, 0.114848133809852, 0.109357832522376, 0.113671108835167, 0.112710666320603, 0.12396737086016, 0.127439129639021, 0.140587177544125, 0.11585982199213, 0.124690999666968, 0.113161658009068, 0.132245953801939, 0.101205188373861, 0.125043524955854, 0.113374220136956 ]
