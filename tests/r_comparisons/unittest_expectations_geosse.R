library(diversitree)
library(phytools)
library(stringr)

source("unittest_R_utils.R")

## GeoSSE effectively
## params
sA <- 1.25
sB <- 1.25
sAB <- 0.75
xA <- 1.0
xB <- 1.0
dA <- 1.0
dB <- 1.0

pars = c(sA, sB, sAB, xA, xB, dA, dB)

## simulation specs
n.batches <- 100
n.sim <- 100
size.tr <- 50 # for simulations with max.taxa
max.age <- 4.0 # for simulations with max.age

## storing things
trs.list.max.taxa <- rep(list(vector(mode="list", length=n.sim)), n.batches) # store trees with different ages, same number of extant taxa
spec.df.max.taxa <- as.data.frame(matrix(rep(0, n.batches * n.sim * 6), nrow=n.batches * n.sim))

trs.list.max.t <- rep(list(vector(mode="list", length=n.sim)), n.batches) # store trees with different numbers of extant taxa, same origin age (but different root age)

spec.df.max.t <- as.data.frame(matrix(rep(0, n.batches * n.sim * 6), nrow=n.batches * n.sim))

names(spec.df.max.taxa) <- names(spec.df.max.t) <-  c("ntotal", "ntips", "n1", "n2", "n3", "root.age")


######## max.t ########
set.seed(123)
null.count <- 0
for (b in 1:n.batches) {
    null.count = 0 # in case we want to know anything about this later

    if (b %% 5 == 0) { cat("batch ", b, "\r") }

    for (i in 1:n.sim) {
        tr.max.t = NULL

        ## conditioning on speciation (done by default by diversitree)
        while (is.null(tr.max.t)) {
            tr.max.t = tree.geosse(pars, max.t=max.age, x0=1, include.extinct=TRUE)

            if (!is.null(tr.max.t)) {
                ## conditioning on survival
                while (length(table(str_detect(tr.max.t$tip.label, "ex"))) <2) {
                    tr.max.t = tree.geosse(pars, max.t=max.age, x0=1, include.extinct=TRUE)
                }

                trs.list.max.t[[b]][[i]] = tr.max.t # b-th batch, i-th tree with max.t
                ith.specs.df.max.t = get.specs(tr.max.t, w.states=TRUE, w.root=TRUE, three.states=TRUE, geosse=TRUE)
                spec.df.max.t$ntotal[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.total"
                spec.df.max.t$root.age[(b-1) * n.batches + i] = ith.specs.df.max.t$"tr.h"
                spec.df.max.t$ntips[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.tips"
                ## IMPORTANT: in diversitree's GeoSSE, state 0 is AB, 1 is A and 2 is B
                spec.df.max.t$n3[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.0"
                spec.df.max.t$n1[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.1"
                spec.df.max.t$n2[(b-1) * n.batches + i] = ith.specs.df.max.t$"n.2"
            } else {
                null.count = null.count + 1
            }
        }
    }
}

## getting stats (mean, stdev, stderr) for different tree specs
mean.df.max.t <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
sd.df.max.t <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
stderr.df.max.t <- data.frame(matrix(rep(0.0, 6 * n.batches), nrow=n.batches))
names(mean.df.max.t) <- names(sd.df.max.t) <- names(stderr.df.max.t) <- c("ntotal", "ntips", "n1", "n2", "n3", "root.age")
n1.ci.width.max.t <- n2.ci.width.max.t <- n3.ci.width.max.t <- root.age.ci.width.max.t <- rep(0.0, n.batches)
for (b in 1:n.batches) {
    bth.batch.df = spec.df.max.t[((b-1) * n.batches + 1):((b-1) * n.batches + n.sim),]
    mean.df.max.t[b,] = sapply(bth.batch.df, mean)
    sd.df.max.t[b,] = sapply(bth.batch.df, sd)
    stderr.df.max.t[b,] = sd.df.max.t[b,] / sqrt(n.sim)

    n1.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "n1"] # actually half width, which we use in unit test
    n2.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "n2"]
    n3.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "n3"]
    root.age.ci.width.max.t[b] = 1.96 * stderr.df.max.t[b, "root.age"]
}

## getting means and 95-CI widths (for unit test)
cat("\nn1_ci_width_maxt = [", paste(n1.ci.width.max.t, collapse=", "), "]\n")
cat("\nn1_mean = [", paste(mean.df.max.t$n1, collapse=", "), "]\n")
cat("\nn2_ci_width_maxt = [", paste(n2.ci.width.max.t, collapse=", "), "]\n")
cat("\nn2_mean = [", paste(mean.df.max.t$n2, collapse=", "), "]\n")
cat("\nn3_ci_width_maxt = [", paste(n3.ci.width.max.t, collapse=", "), "]\n")
cat("\nn3_mean = [", paste(mean.df.max.t$n3, collapse=", "), "]\n")
cat("\nroot_ages_ci_width_maxt = [", paste(root.age.ci.width.max.t, collapse=", "), "]\n")
cat("\nroot_ages_mean_maxt = [", paste(mean.df.max.t$root.age, collapse=", "), "]\n")

## n1_ci_width_maxt = [ 7.61469739677451, 11.3985221565576, 8.65236794353448, 10.2719102405688, 8.82729473870905, 7.70410967867216, 9.19737917311999, 7.65009915182328, 11.3995816970925, 9.63261816961599, 9.97532174919687, 8.81487721488708, 10.6127667839497, 9.25557381626244, 8.55505148722618, 8.52496771180236, 8.57001653169557, 7.77857270862941, 9.0760256388115, 7.15316029941249, 10.3731219966787, 8.75694882511349, 10.0212869145957, 9.15229272426899, 8.17145835184636, 7.1925008330015, 7.35829067766215, 10.0924093088105, 9.51714075482078, 12.1101580591075, 7.72996876693417, 8.53009515027396, 7.75820360338108, 6.86971562506724, 7.52897407055912, 8.73244885412443, 7.43357805722986, 10.7427498156485, 8.47732093863183, 9.87844242415133, 8.34919938338008, 9.07318523059498, 7.0852982026022, 10.9373987128401, 7.04542104824621, 9.69906705591582, 9.27533777513403, 8.28162138724152, 8.183374671154, 7.42275229457825, 10.0578122764487, 10.6860425637531, 8.18308944607257, 8.78593095039168, 9.89143979420712, 9.51446425623809, 9.64454069681523, 8.91552490905838, 9.69933610607375, 7.98525740548914, 6.03309895730932, 8.95067512054456, 10.3671044425543, 6.99102857177062, 7.26507093961069, 9.58798159102837, 8.94412574097117, 7.79294226345969, 9.1445577265686, 8.47966721512065, 7.44395047275357, 7.44453454732145, 7.90833780121852, 7.87533376675413, 9.38851097549391, 9.82664274952889, 11.2284870606467, 8.21700091461033, 9.12816349670766, 7.14562163322776, 8.12917764315305, 7.34292766273794, 10.0978452654239, 10.5197246371766, 10.3216140621748, 8.85310148099112, 7.88410364521452, 10.7200694286912, 9.7131886061471, 10.0851927842233, 9.39527345867231, 8.70678031537502, 6.91329700174551, 8.88098493864301, 7.79608660710324, 8.35036678795209, 8.69793695274571, 10.236955535034, 8.64278402433574, 7.64048733587701 ]

## n1_mean = [ 41.85, 61.05, 52.1, 56.09, 48.05, 43.57, 55.08, 48.31, 54.7, 54.23, 48.65, 49.41, 54.81, 55.18, 47.38, 45.69, 45.2, 46.38, 51.56, 48.11, 52.51, 41.49, 53.84, 48.87, 47.65, 43.09, 45.5, 51.8, 47.47, 55.96, 43.36, 48.65, 49.2, 45.82, 49.87, 44.45, 38.97, 56.53, 51.27, 47, 50, 54.39, 45.73, 56.83, 45.38, 57.67, 47.71, 48.23, 49.01, 44.66, 53.84, 52.92, 45.48, 50.74, 52.09, 55.06, 56.2, 45.5, 48.38, 45.02, 44.76, 47.69, 51.92, 44.14, 49, 52.95, 48.92, 45.09, 53.79, 48.24, 44.29, 45.3, 52.84, 42.49, 51.98, 54.62, 49.04, 49.09, 50.21, 46.4, 50.44, 44.52, 53.46, 51.42, 47.4, 51.79, 46.78, 61.34, 51.12, 54.95, 52.13, 49.22, 42.55, 48.53, 53.57, 46.24, 52.93, 55.95, 49.04, 50.56 ]

## n2_ci_width_maxt = [ 7.86543478223139, 10.7037057757271, 7.75001553609391, 10.0482772865137, 9.67590376274271, 8.43811369212409, 9.31955418745603, 7.6927483597781, 11.3025300254484, 9.29364062306624, 9.41544995853178, 9.40119590234899, 9.67069448241031, 10.1166521116964, 8.53786688842386, 8.65730339110607, 9.34167726907732, 7.89741647657286, 8.99083241377156, 7.59152376490592, 9.61747014963872, 8.47350367670847, 10.5828067378225, 8.93082443864727, 7.85468723257751, 7.95373211466914, 6.91299642135132, 10.3637539188513, 9.2578425219711, 12.204334549808, 7.6979242748558, 8.64153039195903, 7.85319686777559, 7.10611412929639, 6.97785358749271, 9.08683607427844, 7.20986951887424, 11.1676130178098, 9.18034973775372, 8.55192461258832, 8.43517003441513, 9.01724890779059, 7.25113713130359, 10.4206445102833, 8.04153935220933, 9.69270369436034, 9.84071431060928, 8.01884533102044, 7.59853222392192, 6.93145464745294, 9.22874986992367, 9.24938360870659, 8.21480021336213, 8.82923070732849, 9.66104271930532, 9.11204638994585, 9.06621674498634, 8.76253061551735, 9.65159600003434, 7.86942866140673, 5.64418781051836, 8.31118137645445, 9.45872980568584, 6.62377136237432, 6.64063089068069, 9.07603333460764, 8.55654817176632, 7.69166074555076, 8.54410934547743, 7.96227309668933, 7.71305713866055, 7.1179538881577, 8.49921951744138, 8.07576773036146, 9.75057423465175, 9.28206252062373, 10.3589300703316, 8.43785432355019, 9.54283878869756, 7.11980500141554, 8.61420591236395, 8.43310702209219, 9.85239801777243, 9.94580761226568, 10.2791140262793, 8.10130363630921, 7.83586583423435, 10.2240823881855, 9.43259488841161, 9.31054369916931, 9.189959754498, 8.57058046108897, 7.03984064328364, 7.98626397922449, 7.7500613496692, 8.66730710724577, 8.80831563201111, 9.21878862692267, 8.41758235642947, 7.45113159044865 ]

## n2_mean = [ 40.84, 59.7, 47.82, 56.31, 46.62, 43.71, 53.84, 44.73, 53.64, 53.34, 46.31, 50.41, 55.04, 53.88, 48.71, 43.78, 46.08, 46.71, 49.67, 46.44, 48.24, 40.52, 52.47, 45.44, 46.14, 44.64, 41.14, 50.42, 44.5, 54.97, 42.3, 47, 49.27, 46.01, 47.32, 41.56, 37.46, 55.34, 53.54, 43.23, 48.71, 51.14, 44.35, 55.62, 44.93, 55.33, 48.18, 45.74, 44.99, 44.29, 52.1, 47.62, 45.1, 48.54, 51.7, 51.99, 51.86, 44.7, 45.54, 44.19, 41.85, 45.23, 50.07, 42.66, 44.85, 52.3, 47.62, 43.21, 51.31, 46.08, 42.8, 41.99, 53.32, 41.59, 52.61, 51.59, 47.85, 48.63, 49.78, 44.47, 48.53, 44.53, 51.73, 50.62, 45.77, 50.18, 46.01, 58.02, 49.28, 52.46, 49.61, 48.47, 40.7, 45.19, 50.71, 46.89, 51.09, 50.84, 46.75, 46.76 ]

## n3_ci_width_maxt = [ 0.555825735353094, 0.535903520639997, 0.537378626559364, 0.431015479344238, 0.45180169780714, 0.476220887548387, 0.419726510282998, 0.479206042018536, 0.422725071961253, 0.464840207583056, 0.607552099773669, 0.611752962618676, 0.531369663789682, 0.473077481001054, 0.577828248922225, 0.531541248245006, 0.501738190813907, 0.577962543262227, 0.400514697141394, 0.458853836017836, 0.648190363608367, 0.443440497414788, 0.444209889420064, 0.499785442449906, 0.455117663107825, 0.524811583698224, 0.51131800538047, 0.499804852422473, 0.472486534039315, 0.591208418359713, 0.559097333099334, 0.492074396937305, 0.466402798127338, 0.557926636500868, 0.607079281594599, 0.553429463719751, 0.459601647455092, 0.462815625309154, 0.52196460424133, 0.505989306390776, 0.442393555764342, 0.457180580550315, 0.521343476612167, 0.573690115908326, 0.479206042018536, 0.525077696607605, 0.420188509883819, 0.602263038610845, 0.533755921974102, 0.540751076622772, 0.487618454917118, 0.564536503906013, 0.466469352225477, 0.459191980713421, 0.489270891895855, 0.461657136319966, 0.397792654989552, 0.500673647209538, 0.493255849771022, 0.503035811725952, 0.535994023786976, 0.624108225528007, 0.463230464272702, 0.411675413966691, 0.430785843347112, 0.521551841366056, 0.546958526671803, 0.663736507291192, 0.626828677961651, 0.545235393146294, 0.617080164070187, 0.444908182106208, 0.596192091612267, 0.522113267636845, 0.536746418316655, 0.434315922812048, 0.609360109483959, 0.493535046395088, 0.670391315244728, 0.47283544620927, 0.443685448683792, 0.489702940257632, 0.565031187125315, 0.565954124564095, 0.405138507803258, 0.446166703455925, 0.528113662391005, 0.440807477617193, 0.53157044859377, 0.502391282173607, 0.510934615991305, 0.582693292505854, 0.836210982994608, 0.577935686890694, 0.495606391558397, 0.486666560398494, 0.585748619160545, 0.392672554362404, 0.543324707126169, 0.5411205119794 ]

## n3_mean = [ 11.12, 15.51, 13.75, 14.93, 12.76, 11.57, 16.1, 11.6, 14.46, 14.37, 12.83, 13.68, 14.49, 14.43, 13.18, 12.8, 12.3, 13.29, 13.01, 12.42, 13.35, 10.9, 14.5, 12.24, 12.42, 11.3, 11.77, 13.19, 11.88, 14.62, 11.1, 12.43, 12.96, 11.95, 12.68, 11.46, 10.25, 15.62, 13.46, 12.01, 13.59, 13.82, 11.96, 14.91, 12.2, 14.76, 12.72, 12.48, 11.63, 11.14, 14.36, 13.87, 11.93, 13.04, 14.41, 13.94, 14.8, 11.87, 12.23, 12.54, 11.98, 12.74, 13.32, 11.58, 12.97, 13.72, 12.7, 11.71, 14.07, 13.06, 11.37, 11.35, 14.2, 11.25, 13.25, 14.22, 12.8, 13.08, 14.08, 12.51, 13.58, 12.66, 14.23, 14.13, 12.95, 13.61, 12.11, 15.11, 13.16, 13.77, 13, 13.26, 10.63, 12.77, 13.61, 11.7, 13.9, 13.87, 12.57, 13.29 ]

## root_ages_ci_width_maxt = [ 0.0863621436610369, 0.0683344476938087, 0.0764824383260808, 0.0782119002487626, 0.0953901974093536, 0.0828971839834432, 0.0779879908824513, 0.0993078674559366, 0.0964958695619792, 0.0879013012005711, 0.100410281284171, 0.0602099333156964, 0.0627084069830292, 0.0785843068183554, 0.0942952792553635, 0.0869292276344587, 0.0982118725073612, 0.0682497208139858, 0.0678699587739283, 0.0843821450863513, 0.077526933961665, 0.061975429232225, 0.0821942621664972, 0.0971370045704151, 0.0689002363196737, 0.0650862067994434, 0.0710002446906274, 0.110022693716635, 0.0694915820374534, 0.0824715109678761, 0.0810296381623433, 0.0837232755213046, 0.0723647316366736, 0.0863664240763528, 0.0699901475457904, 0.105287588080782, 0.0992796186000226, 0.0814778947653661, 0.0741412029585709, 0.0918229670804907, 0.0814542643144918, 0.0836989354406395, 0.0885605828327472, 0.0802974535163125, 0.0736579950207639, 0.0835150416704483, 0.0859738537095798, 0.0646280878667954, 0.0956631951634727, 0.0656745072776782, 0.0721009457132847, 0.0851020965959267, 0.116276753024932, 0.0754299235710839, 0.078579106169794, 0.0809213516248445, 0.0833969439461317, 0.0786993782768009, 0.081016820640823, 0.0849973399851797, 0.0869738134809529, 0.0848249919742559, 0.0618016950730631, 0.0851971655532165, 0.0754477438432816, 0.0629650954964614, 0.084267636293506, 0.0822303530341302, 0.0786002952327918, 0.0786810829708018, 0.0780211398402472, 0.0795046173750614, 0.0809231134676522, 0.0694291278413427, 0.0862414262233601, 0.074479722758591, 0.0949697676361586, 0.0652331364130727, 0.0876214151851634, 0.0767873923262017, 0.0811177805127541, 0.061941982651136, 0.0759781687997605, 0.0851475507141673, 0.0828628602570979, 0.0883212418535365, 0.0705176195001626, 0.0606045718160437, 0.0618065154283371, 0.0596878566675811, 0.0710418631483221, 0.0873721022509251, 0.0879411359850104, 0.0846850291250342, 0.0787465611609875, 0.0795017393876372, 0.0863436018914586, 0.0804853967955438, 0.076684316999975, 0.067626116341724 ]

## root_ages_mean_maxt = [ 3.50277554651025, 3.59861897156149, 3.55816380865796, 3.52959903544372, 3.51136655797538, 3.47423369407496, 3.52999625188782, 3.55495963518541, 3.54947430506743, 3.54582114303298, 3.49687058713685, 3.64592548954201, 3.62351543644644, 3.5741000772744, 3.48021231352758, 3.54587651094397, 3.50369749483071, 3.57583364060204, 3.62958195248726, 3.5387255728763, 3.53907263016699, 3.5844916129234, 3.51741852548453, 3.50284518908845, 3.58097277731293, 3.59273196624833, 3.57231299558864, 3.49064833503716, 3.5701524209432, 3.50677622091431, 3.57708908296371, 3.50381117773857, 3.52894600681898, 3.5873270084788, 3.63429872627754, 3.49368119662322, 3.43607406780903, 3.56375148175194, 3.58025237571096, 3.53065908927687, 3.59176041885477, 3.58390297784463, 3.51538118479266, 3.55934214586894, 3.63296561318448, 3.55327029199147, 3.54130857912747, 3.57809544981563, 3.52429848949143, 3.56480820074316, 3.56102577967363, 3.51463200814148, 3.48802339469853, 3.5664830497503, 3.54188648014971, 3.54999977432845, 3.53534355838466, 3.56482634976622, 3.55717290844079, 3.56977340393873, 3.51868619417851, 3.50237316170494, 3.62943438217033, 3.51958316584184, 3.53822377005109, 3.61140242193596, 3.53375679542984, 3.55369676402664, 3.62394340710736, 3.52869683509773, 3.55905119814178, 3.59428125478635, 3.5388665381499, 3.53918703396336, 3.55345431040883, 3.56585687239169, 3.51704499377328, 3.58815572523115, 3.51476736659786, 3.54001980130828, 3.58141071029781, 3.5850687855442, 3.56391570702091, 3.52464147005821, 3.5149348452404, 3.54210361161907, 3.5672857719015, 3.61493644562914, 3.64691740182515, 3.64988404345597, 3.58205575470221, 3.47931868027422, 3.49456699746901, 3.50365276356308, 3.59532019717527, 3.54200778846066, 3.61111175136063, 3.59293906165868, 3.57808474027827, 3.60271391529931 ]
